conn, engine = postgres()

eng = engine.connect()

query = """
    SELECT distinct
    t1.nr_trabalho, t1.nm_trab, t1.obj_trab, t1.justif, 
    t1.tx_rel_atvd, t2.tx_rel_atvd as tx_rel_atvd_completa, t1.tx_constatacao
FROM 
    ptai.com_resultado AS t1
LEFT JOIN 
    ptai.com_resultado_tx_completo AS t2 
ON 
    t1.cd_atvd = t2.cd_atvd 
    AND t1.cd_tip_rel_atvd = t2.cd_tip_rel_atvd  
    AND t1.cd_rel_atvd = t2.cd_rel_atvd 
WHERE 
    t1.nr_trabalho in (49699, 49659, 49664, 51471, 46911, 46712, 47777, 49860, 47588) ;

"""

df_temp = pd.read_sql(text(query), eng)

 484 ) -> DataFrame | Iterator[DataFrame]:
    485     """
    486     Read SQL query or database table into a DataFrame.
    487 
   (...)
    597     1           1  2010-11-12
    598     """
--> 599     pandas_sql = pandasSQL_builder(con)
    601     if isinstance(pandas_sql, SQLiteDatabase):
    602         return pandas_sql.read_query(
    603             sql,
    604             index_col=index_col,
   (...)
    608             chunksize=chunksize,
    609         )

File ~/anaconda3/lib/python3.9/site-packages/pandas/io/sql.py:788, in pandasSQL_builder(con, schema, meta, is_cursor)
    786 con = _engine_builder(con)
    787 if _is_sqlalchemy_connectable(con):
--> 788     return SQLDatabase(con, schema=schema, meta=meta)
    789 elif isinstance(con, str):
    790     raise ImportError("Using URI string without sqlalchemy installed.")

File ~/anaconda3/lib/python3.9/site-packages/pandas/io/sql.py:1410, in SQLDatabase.__init__(self, engine, schema, meta)
   1407 if not meta:
   1408     from sqlalchemy.schema import MetaData
-> 1410     meta = MetaData(self.connectable, schema=schema)
   1412 self.meta = meta

TypeError: __init__() got multiple values for argument 'schema'




/usr/local/lib/python3.8/dist-packages/sqlalchemy/engine/base.py in execute(self, statement, parameters, execution_options)
   1414             meth = statement._execute_on_connection
   1415         except AttributeError as err:
-> 1416             raise exc.ObjectNotExecutableError(statement) from err
   1417         else:
   1418             return meth(

ObjectNotExecutableError: Not an executable object: '\n    SELECT distinct\n    t1.nr_trabalho, t1.nm_trab, t1.obj_trab, t1.justif, \n    t1.tx_rel_atvd, t2.tx_rel_atvd as tx_rel_atvd_completa, t1.tx_constatacao\nFROM \n    ptai.com_resultado AS t1\nLEFT JOIN \n    ptai.com_resultado_tx_completo AS t2 \nON \n    t1.cd_atvd = t2.cd_atvd \n    AND t1.cd_tip_rel_atvd = t2.cd_tip_rel_atvd  \n    AND t1.cd_rel_atvd = t2.cd_rel_atvd \nWHERE \n    t1.nr_trabalho in (49699, 49659, 49664, 51471, 46911, 46712, 47777, 49860, 47588) ;\n\n'



with engine.connect() as conn:
    df_temp = pd.read_sql(query, conn)

def postgres(ht="172.16.13.65", db="mefis", **auth):
    """
    Retorna uma conexao com o PostgreSQL.
    Parâmetros:
    
    ht - host (endereço IP ou nome de host onde o banco de dados está hospedado)
    db - database (nome do banco de dados)
    auth - parâmetros de autenticação (usr e pw) conforme abaixo. Devem ser informados como parãmetros nomeados.
        usr - user (nome do usuário para autenticar no banco de dados)
        pw - password (senha do usuário para conexão)
    """
    
    
    usr=auth.setdefault('usr', USR_PG_ROOT)
    pw=auth.setdefault('pw', PWD_PG_ROOT)
    

    
    conn = psycopg2.connect(host=ht,
                            database=db, 
                            user=usr, 
                            password=pw)
    
    engine = create_engine('postgresql://{user}:{password}@{host}:5432/{database}'.format(user=usr, 
                                                                                          password=pw, 
                                                                                          host=ht, 
                                                                                          database=db))
    
    return conn, engine


query = """
    SELECT distinct
    t1.nr_trabalho, t1.nm_trab, t1.obj_trab, t1.justif, 
    t1.tx_rel_atvd, t2.tx_rel_atvd as tx_rel_atvd_completa, t1.tx_constatacao
FROM 
    ptai.com_resultado AS t1
LEFT JOIN 
    ptai.com_resultado_tx_completo AS t2 
ON 
    t1.cd_atvd = t2.cd_atvd 
    AND t1.cd_tip_rel_atvd = t2.cd_tip_rel_atvd  
    AND t1.cd_rel_atvd = t2.cd_rel_atvd 
WHERE 
    t1.nr_trabalho in (49699, 49659, 49664, 51471, 46911, 46712, 47777, 49860, 47588) ;

"""

df_temp = pd.read_sql(query, engine)


   ---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
/tmp/ipykernel_700/2782855730.py in <module>
     16 """
     17 
---> 18 df_temp = pd.read_sql(query, engine)

~/.local/lib/python3.8/site-packages/pandas/io/sql.py in read_sql(sql, con, index_col, coerce_float, params, parse_dates, columns, chunksize)
    588         )
    589     else:
--> 590         return pandas_sql.read_query(
    591             sql,
    592             index_col=index_col,

~/.local/lib/python3.8/site-packages/pandas/io/sql.py in read_query(self, sql, index_col, coerce_float, parse_dates, params, chunksize, dtype)
   1558         args = _convert_params(sql, params)
   1559 
-> 1560         result = self.execute(*args)
   1561         columns = result.keys()
   1562 

~/.local/lib/python3.8/site-packages/pandas/io/sql.py in execute(self, *args, **kwargs)
   1403     def execute(self, *args, **kwargs):
   1404         """Simple passthrough to SQLAlchemy connectable"""
-> 1405         return self.connectable.execution_options().execute(*args, **kwargs)
   1406 
   1407     def read_table(

AttributeError: 'OptionEngine' object has no attribute 'execute'

