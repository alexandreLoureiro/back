/* VARIÁVEIS */
%LET PASTA_GA = /dados/audit/gamefis/aud/interno/RCM_EE;
%LET PATH = &PASTA_GA./script;/* VARIÁVEIS */



%let data_hoje = %sysfunc(putn(%sysfunc(today()), date7.));

%let dia_atual = %sysfunc(day(%sysfunc(today())));
%let mes_atual = %sysfunc(month(%sysfunc(today())));
%let ano_atual = %sysfunc(year(%sysfunc(today())));
%let dia_semana = %sysfunc(weekday(%sysfunc(today())));

data _null_;
    set dados.data_envio_email;
    format ultimo_envio date7.;
    where month(ultimo_envio) = &mes_atual and year(ultimo_envio) = &ano_atual;
    call symputx('data_envio', put(ultimo_envio, date7.));
run;

%put data ultimo envio &data_envio;

%let data_envio_num = %sysfunc(inputn(&data_envio., date7.));
%let dia_envio = %sysfunc(day(&data_envio_num));
%let mes_envio = %sysfunc(month(&data_envio_num));
%let ano_envio = %sysfunc(year(&data_envio_num));

%macro verificar_envio;
    %if %eval(&dia_atual > 20) and %eval(%index(1 7, &dia_semana) = 0) %then %do;
        %if %symexist(data_envio) and &dia_envio > 20 and &mes_envio = &mes_atual and &ano_envio = &ano_atual %then %do;
            %put Já existe um envio registrado após o dia 20 deste mês;
        %end;
        %else %do;
            %include "&PATH./controle_email.sas";
            proc sql; 
                insert into dados.data_envio_email (ultimo_envio) 
                values ("&data_hoje."d); 
            quit;
        %end;
    %end;
    %else %do;
        %put O dia atual é inferior ou igual ao dia 20 ou não é um dia útil. O script não será executado.;
    %end;
%mend verificar_envio;

%verificar_envio;



/*
proc sql;
    create table dados.data_envio_email (
        ultimo_envio date
    );
quit;

proc sql;
    delete from  dados.data_envio_email ;
quit;

proc sql;
    delete from  dados.data_envio_email where ultimo_envio = '27AUG24'd;
quit;

proc contents data=dados.data_envio_email;
run;


proc sql;
    insert into dados.data_envio_email (ultimo_envio)
    values (%sysfunc(today(), yymmdd10.));
quit;


*/

proc sql;
    insert into dados.data_envio_email (ultimo_envio)
    values ('20JUL2024'd);
    insert into dados.data_envio_email (ultimo_envio)
    values ('21JUL2024'd);
    insert into dados.data_envio_email (ultimo_envio)
    values ('19AUG2024'd);
    insert into dados.data_envio_email (ultimo_envio)
    values ('01AUG2024'd);
    insert into dados.data_envio_email (ultimo_envio)
    values ('15SEP2024'd);
quit;


o controle_email.sas cria a tabela em uma área mapeada, fora da work, para não perder os dados (dados.data_envio_email). Como teste, deixei o script que insere dados, o script teste_controle_email.sas, que tem a “inteligência” para verificar se a data atual é superior ao dia 20 e se é um dia da semana. Se ambas as regras forem atendidas, verifica a última data de envio de email na tabela dados.data_envio_email. Se o último dia não for superior ao dia 20 do mês e ano corrente, efetua a ação do script vinculado %include "&PATH./controle_email.sas" (aqui usei como teste; você coloca o script que gera os emails) e insere a última data nessa tabela. Caso contrário, não faz nada. O script teste_controle_email.sas, renomeado para controle_email.sas, tem que estar agendado para rodar todos os dias no agendamento corporativo SAS.

