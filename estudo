%macro send_email_if_table_not_empty;
    /* Verifica se a tabela work.cria_dados_email está vazia */
    proc sql noprint;
        select count(*) into :row_count from work.cria_dados_email;
    quit;

    /* Se a tabela não estiver vazia, executa o código para enviar o email */
    %if &row_count > 0 %then %do;

        /* Configurações de email */
        options emailauthprotocol=none 
                emailid='audit.mefis@bb.com.br' 
                emailsys=smtp 
                emailhost='smtp.bb.com.br' 
                emailport=25;
        filename newEmail email lrecl=64000;

        data _null_;
            set work.cria_dados_email end=FINAL;

            /* Remover espaços em branco e aspas dos endereços de email */
            email_to = compress(strip(destino), "'"" ");
            email_cc = compress(strip(destino_cc), "'"" ");
            email_bcc = compress(strip(destino_cco), "'"" ");

            /* Construir o assunto do email */
            assunto = "Recomendação: " || strip(titulo) || ".";

            /* Configurar o arquivo de email */
            file newEmail 
                to=(email_to)
                cc=(email_cc)
                bcc=(email_bcc)
                from='audit.mefis@bb.com.br'
                subject=assunto
                content_type='text/html';

            /* Depuração: imprimir valores no log */
            put 'DEBUG: email_to=' email_to;
            put 'DEBUG: email_cc=' email_cc;
            put 'DEBUG: email_bcc=' email_bcc;
            put 'DEBUG: assunto=' assunto;

            /* Escrever o corpo do email usando a coluna mensagem_html */
            put mensagem_html;

            /* Enviar o email */
            put '!EM_SEND!' / '!EM_NEWMSG!';

            /* Se for o último registro, abortar o envio para encerrar */
            if FINAL then 
                put '!EM_ABORT!';
        run;

        /* Limpar a referência ao arquivo de email */
        filename newEmail clear;

        /* Atualizar a situação dos registros enviados (opcional) */
        /* Caso precise atualizar a situação dos registros no banco de dados, você pode adicionar o código aqui */
    %end;
%mend send_email_if_table_not_empty;

/* Chamar o macro */
%send_email_if_table_not_empty;
