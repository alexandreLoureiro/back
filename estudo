PROC SQL;
CREATE TABLE WORK.cria_dados_email AS 
SELECT * FROM PGMEFIS.mensageria_plataforma T1 WHERE SITUACAO = 'A_ENVIAR';
QUIT;

%Macro Envia_Email;
    proc sql noprint;
        select count(*) into :row_count from WORK.cria_dados_email;
    quit;

    %if &row_count > 0 %then %do;
        options emailauthprotocol=none emailid='@' emailsys=smtp emailhost=smtp emailport=25;
        filename newEmail email lrecl=64000;

        data _null_;
            SET work.cria_dados_email;
            destino1 = destino;
            destino2 = destino_cc;
            assunto = "Recomendação: " || titulo || ".";

            file newEmail 
                from  = "audit.mefis@bb.com.br"
                to = destino1
                cc = destino2
                subject = assunto
                content_type = "text/html";

            put mensagem_html;
        run;

        /* Clear the filename reference */
        filename newEmail clear;
    %end;
%Mend;

%Macro Altera_Situacao;
    proc sql noprint;
        select id into :id_list separated by ',' from WORK.cria_dados_email;
    quit;

    proc sql;
        connect to postgres as comm(server="&_servidor" port="&_porta" user="&_usuario" password="&_senha" database="&_basedados");
        execute (
            UPDATE mensageria_plataforma
            SET situacao = 'ENVIADO', DATA_ENVIO = current_timestamp
            WHERE id IN (&id_list)
        ) by comm;
        disconnect from comm;
    quit;
%Mend;

%Envia_Email;
%Altera_Situacao;


%Macro Envia_Email;
    /* Verificar se há registros a serem processados */
    proc sql noprint;
        select count(*) into :row_count from WORK.cria_dados_email;
    quit;

    %if &row_count > 0 %then %do;
        /* Configurar as opções de email */
        options emailauthprotocol=none 
                emailid='audit.mefis@bb.com.br' 
                emailsys=smtp 
                emailhost=smtp.bb.com.br 
                emailport=25;

        /* Definir o arquivo de email */
        filename newEmail email lrecl=64000;

        /* Enviar os emails */
        data _null_;
            set work.cria_dados_email;
            
            /* Remover espaços em branco das variáveis de email */
            destino1 = strip(destino);
            destino2 = strip(destino_cc);
            destino3 = strip(destino_cco);
            assunto = "Recomendação: " || strip(titulo) || ".";	

            /* Depuração: imprimir valores no log */
            put 'DEBUG: destino1=' destino1;
            put 'DEBUG: destino2=' destino2;
            put 'DEBUG: destino3=' destino3;
            put 'DEBUG: assunto=' assunto;

            /* Configurar o arquivo de email */
            file newEmail 
                to=(destino1)
                cc=(destino2)
                bcc=(destino3)
                from='audit.mefis@bb.com.br'
                subject=assunto
                content_type='text/html';

            /* Escrever o conteúdo do email */
            put mensagem_html;
        run;

        /* Limpar a referência do arquivo */
        filename newEmail clear;
    %end;
%Mend;
